# 郵件系統設定指南

## 概述

本系統已完全改為使用 Google App Script (GAS) 發送郵件，移除了所有 SMTP 設定。所有郵件都通過 Google App Script 服務發送，並將記錄保存在 Firebase 資料庫中。

## 系統架構

```
前端應用 → JSONP 調用 → Google App Script → Gmail API → 收件人
    ↓
Firebase 資料庫 (郵件記錄)
```

**注意：系統使用 JSONP 方式調用 Google App Script 來避免 CORS 問題**

## 設定步驟

### 1. 部署 Google App Script

1. **創建 Google App Script 專案**
   - 前往 [Google Apps Script](https://script.google.com)
   - 點擊「新增專案」
   - 將專案命名為「農鮮市集郵件服務」

2. **貼上程式碼**
   - 刪除預設的 `Code.gs` 內容
   - 將 `google-app-script-email-service.js` 的內容完整貼上

3. **啟用 Gmail API**
   - 在左側選單選擇「服務」
   - 找到「Gmail API」並啟用

4. **部署為 Web App**
   - 點擊右上角「部署」→「新增部署」
   - 選擇類型：「網頁應用程式」
   - 執行身份：選擇您的 Google 帳戶
   - 存取權限：「任何人」
   - 點擊「部署」
   - **重要：系統使用 JSONP 方式，無需擇心 CORS 問題**

5. **複製 Script ID**
   - 部署完成後，從 Web App URL 中提取 Script ID
   - URL 格式：`https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec`
   - 只需要 YOUR_SCRIPT_ID 部分

### 2. 設定環境變數

1. **複製環境變數範例**
   ```bash
   cp .env.example .env
   ```

2. **編輯 .env 文件**
   ```bash
   # 設定 Google App Script ID
   VITE_GOOGLE_APP_SCRIPT_ID=YOUR_SCRIPT_ID
   ```

### 3. 系統設定

1. **啟動應用程式**
   ```bash
   npm start
   ```

2. **進入管理後台**
   - 前往 `/admin` 路徑
   - 點擊「郵件管理」

3. **設定郵件參數**
   - 填入寄件者名稱
   - 填入寄件者信箱
   - 填入管理員信箱
   - 啟用郵件功能

4. **測試郵件功能**
   - 點擊「測試郵件發送」按鈕
   - 檢查管理員信箱是否收到測試郵件

## 功能特點

### 1. 完全使用 Google App Script
- 移除所有 SMTP 相關設定
- 所有郵件通過 Google App Script 發送
- 利用 Gmail API 的可靠性和穩定性

### 2. 資料庫記錄
- 所有郵件發送記錄保存在 Firebase
- 支援詳細的統計資訊
- 可查看發送狀態和錯誤訊息

### 3. 測試功能
- 內建郵件測試功能
- 可直接在管理介面測試郵件發送
- 測試結果即時顯示

### 4. 環境變數支援
- 支援透過環境變數設定 Script ID
- 便於不同環境的部署管理
- 系統自動組合為完整的 GAS URL

## 郵件記錄功能

### 記錄內容
- 發送時間
- 收件人地址
- 郵件主旨
- 郵件類型
- 發送狀態
- 訊息 ID
- 錯誤訊息（如果有）

### 統計功能
- 總發送量
- 成功/失敗數量
- 成功率計算
- 按類型統計

## 故障排除

### 常見問題

1. **測試郵件發送失敗**
   - 檢查 Google App Script ID 是否正確設定
   - 確認 GAS 已正確部署且可訪問
   - 檢查寄件者郵箱是否正確
   - 系統使用 JSONP 方式，不會有 CORS 問題

2. **郵件未收到**
   - 檢查垃圾郵件資料夾
   - 確認收件人地址正確
   - 查看郵件記錄頁面的錯誤訊息

3. **權限錯誤**
   - 確認 Google App Script 的執行權限
   - 檢查 Gmail API 是否已啟用
   - 確認部署設定中的存取權限

### 除錯方法

1. **查看 Google App Script 日誌**
   - 在 GAS 編輯器中查看執行日誌
   - 檢查是否有錯誤訊息

2. **查看瀏覽器開發者工具**
   - 檢查網路請求是否成功
   - 查看回應內容

3. **查看郵件記錄**
   - 在管理後台的郵件記錄頁面查看詳細資訊
   - 檢查錯誤訊息和狀態

## 安全性考量

### 1. 權限控制
- Google App Script 只能由部署者的 Google 帳戶執行
- 前端無法直接訪問敏感資訊

### 2. 資料驗證
- 所有輸入都經過嚴格驗證
- 防止惡意輸入和 XSS 攻擊

### 3. 錯誤處理
- 完善的錯誤處理機制
- 避免敏感資訊洩漏

## 更新和維護

### 更新 Google App Script
1. 在 GAS 編輯器中更新程式碼
2. 重新部署（版本會自動更新）
3. 測試新功能

### 更新前端設定
1. 修改環境變數或資料庫設定
2. 重新啟動應用程式
3. 測試郵件功能

### 監控和維護
- 定期檢查郵件發送統計
- 監控錯誤率
- 及時處理失敗的郵件

## 支援和聯絡

如需技術支援或有任何問題，請聯絡開發團隊。

---

*最後更新：2025-01-16*
*版本：2.0.0*