import React, { useState, useEffect } from 'react';
import {
  Row,
  Col,
  Card,
  Form,
  Input,
  Select,
  Button,
  Typography,
  Divider,
  Steps,
  Radio,
  Space,
  List,
  message,
  Modal,
  Tag,
  Alert
} from 'antd';
import {
  UserOutlined,
  EnvironmentOutlined,
  CreditCardOutlined,
  CheckCircleOutlined,
  ShoppingOutlined,
  GiftOutlined,
  PercentageOutlined
} from '@ant-design/icons';
import emailService from '../services/emailService';
import couponService from '../services/couponService';
import orderService from '../services/orderService';
import paymentService from '../services/paymentService';

const { Title, Text } = Typography;
const { TextArea } = Input;

const CheckoutPage = ({ 
  cart, 
  getTotalPrice, 
  onPageChange, 
  onOrderComplete,
  appliedCoupon,
  discountAmount = 0
}) => {
  const [currentStep, setCurrentStep] = useState(0);
  const [orderData, setOrderData] = useState({});
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [paymentMethods, setPaymentMethods] = useState([]);
  const [orderSuccessModalVisible, setOrderSuccessModalVisible] = useState(false);
  const [orderResult, setOrderResult] = useState(null);

  const shippingFee = 100;
  const subtotal = getTotalPrice();
  const totalAmount = subtotal + shippingFee - discountAmount;

  // ËºâÂÖ•ÂïüÁî®ÁöÑ‰ªòÊ¨æÊñπÂºè
  useEffect(() => {
    const loadPaymentMethods = async () => {
      try {
        const result = await paymentService.getActivePaymentMethods();
        if (result.success) {
          // ËΩâÊèõÊ†ºÂºèÁÇ∫ÁµêÂ∏≥È†ÅÈù¢ÊâÄÈúÄÊ†ºÂºè
          const formattedMethods = result.data.map(method => ({
            value: method.id,
            label: method.name,
            icon: method.icon,
            type: method.type,
            description: method.description,
            settings: method.settings
          }));
          setPaymentMethods(formattedMethods);
        }
      } catch (error) {
        console.error('ËºâÂÖ•‰ªòÊ¨æÊñπÂºèÂ§±Êïó:', error);
        // Â¶ÇÊûúËºâÂÖ•Â§±ÊïóÔºå‰ΩøÁî®È†êË®≠ÊñπÂºè
        setPaymentMethods([
          { value: 'credit_card', label: '‰ø°Áî®Âç°‰ªòÊ¨æ', icon: 'üí≥' },
          { value: 'bank_transfer', label: 'ÈäÄË°åËΩâÂ∏≥', icon: 'üè¶' },
          { value: 'cash_on_delivery', label: 'Ë≤®Âà∞‰ªòÊ¨æ', icon: 'üí∞' }
        ]);
      }
    };

    loadPaymentMethods();
  }, []);

  const cities = [
    'Âè∞ÂåóÂ∏Ç', 'Êñ∞ÂåóÂ∏Ç', 'Ê°ÉÂúíÂ∏Ç', 'Âè∞‰∏≠Â∏Ç', 'Âè∞ÂçóÂ∏Ç', 'È´òÈõÑÂ∏Ç',
    'Âü∫ÈöÜÂ∏Ç', 'Êñ∞Á´πÂ∏Ç', 'ÂòâÁæ©Â∏Ç', 'Êñ∞Á´πÁ∏£', 'ËãóÊ†óÁ∏£', 'ÂΩ∞ÂåñÁ∏£',
    'ÂçóÊäïÁ∏£', 'Èõ≤ÊûóÁ∏£', 'ÂòâÁæ©Á∏£', 'Â±èÊù±Á∏£', 'ÂÆúËò≠Á∏£', 'Ëä±ËìÆÁ∏£',
    'Âè∞Êù±Á∏£', 'ÊæéÊπñÁ∏£', 'ÈáëÈñÄÁ∏£', 'ÈÄ£Ê±üÁ∏£'
  ];

  const handleNext = async () => {
    try {
      const values = await form.validateFields();
      setOrderData({ ...orderData, ...values });
      
      if (currentStep < 2) {
        setCurrentStep(currentStep + 1);
      } else {
        // Êèê‰∫§Ë®ÇÂñÆ
        handleSubmitOrder({ ...orderData, ...values });
      }
    } catch (error) {
      console.error('Form validation failed:', error);
    }
  };

  const handlePrev = () => {
    setCurrentStep(currentStep - 1);
  };

  const handleSubmitOrder = async (data) => {
    setLoading(true);
    
    try {
      const orderId = `ORD${Date.now()}`;
      const orderData = {
        id: orderId,
        customerName: data.customerName,
        customerEmail: data.customerEmail,
        customerPhone: data.customerPhone,
        orderDate: new Date().toISOString(),
        status: 'pending',
        subtotal: subtotal,
        discountAmount: discountAmount,
        appliedCoupon: appliedCoupon,
        couponInfo: appliedCoupon ? {
          code: appliedCoupon.code,
          name: appliedCoupon.name,
          type: appliedCoupon.type,
          description: appliedCoupon.description
        } : null,
        total: totalAmount,
        items: cart.map(item => ({
          id: item.id,
          name: item.name,
          quantity: item.quantity,
          price: item.price,
          image: item.image,
          farm: item.farm || '',
          location: item.location || ''
        })),
        shippingAddress: `${data.city} ${data.address}`,
        paymentMethod: data.paymentMethod,
        paymentStatus: data.paymentMethod === 'credit_card' ? 'paid' : 'pending',
        notes: data.notes || '',
        shippingInfo: null,
        emailNotifications: {
          orderConfirmation: { 
            sent: false, 
            sentAt: null, 
            status: 'pending' 
          }
        }
      };

      // ÂÑ≤Â≠òË®ÇÂñÆÂà∞ Firestore
      const saveResult = await orderService.addWithId(orderId, orderData);
      if (!saveResult.success) {
        throw new Error('Ë®ÇÂñÆÂÑ≤Â≠òÂ§±Êïó');
      }

      // ‰ΩøÁî®ÂÑ™ÊÉ†Âà∏
      if (appliedCoupon) {
        const useCouponResult = await couponService.useCoupon(appliedCoupon.code, 'guest', orderId);
        if (!useCouponResult.success) {
          console.warn('Failed to update coupon usage:', useCouponResult.error);
        }
      }

      // ÁôºÈÄÅË®ÇÂñÆÁ¢∫Ë™çÈÉµ‰ª∂Ôºà‰∏çÂΩ±ÈüøË®ÇÂñÆÊàêÂäüËàáÂê¶Ôºâ
      let emailResult = { success: false };
      try {
        emailResult = await emailService.sendOrderConfirmationEmail(orderData);
      } catch (emailError) {
        console.warn('Email service error:', emailError);
      }
      
      // Êõ¥Êñ∞ÈÉµ‰ª∂ÁôºÈÄÅÁãÄÊÖãÔºà‰∏çÂΩ±ÈüøË®ÇÂñÆÊàêÂäüËàáÂê¶Ôºâ
      try {
        if (emailResult.success) {
          await orderService.update(saveResult.id, {
            emailNotifications: {
              orderConfirmation: {
                sent: true,
                sentAt: new Date().toISOString(),
                status: 'delivered'
              }
            }
          });
        } else {
          await orderService.update(saveResult.id, {
            emailNotifications: {
              orderConfirmation: {
                sent: false,
                sentAt: new Date().toISOString(),
                status: 'failed'
              }
            }
          });
        }
      } catch (updateError) {
        console.warn('Failed to update email status:', updateError);
      }
      
      // Ë®≠ÁΩÆË®ÇÂñÆÁµêÊûú‰∏¶È°ØÁ§∫ÊàêÂäü Modal
      setOrderResult({
        orderId,
        emailSuccess: emailResult.success
      });
      setOrderSuccessModalVisible(true);
      
      message.success('Ë®ÇÂñÆÂ∑≤ÊàêÂäüÊèê‰∫§ÔºÅ');
    } catch (error) {
      console.error('Ë®ÇÂñÆÊèê‰∫§Â§±Êïó:', error);
      message.error('Ë®ÇÂñÆÊèê‰∫§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
    } finally {
      setLoading(false);
    }
  };

  const renderStepContent = () => {
    switch (currentStep) {
      case 0:
        return (
          <Form form={form} layout="vertical">
            <Title level={4}>ÈÖçÈÄÅË≥áË®ä</Title>
            <Row gutter={16}>
              <Col span={12}>
                <Form.Item
                  name="customerName"
                  label="Êî∂‰ª∂‰∫∫ÂßìÂêç"
                  rules={[{ required: true, message: 'Ë´ãËº∏ÂÖ•Êî∂‰ª∂‰∫∫ÂßìÂêç' }]}
                >
                  <Input prefix={<UserOutlined />} placeholder="Ë´ãËº∏ÂÖ•Êî∂‰ª∂‰∫∫ÂßìÂêç" />
                </Form.Item>
              </Col>
              <Col span={12}>
                <Form.Item
                  name="customerPhone"
                  label="ËÅØÁµ°ÈõªË©±"
                  rules={[
                    { required: true, message: 'Ë´ãËº∏ÂÖ•ËÅØÁµ°ÈõªË©±' },
                    { pattern: /^09\d{8}$/, message: 'Ë´ãËº∏ÂÖ•Ê≠£Á¢∫ÁöÑÊâãÊ©üËôüÁ¢ºÊ†ºÂºè' }
                  ]}
                >
                  <Input placeholder="Ë´ãËº∏ÂÖ•ËÅØÁµ°ÈõªË©±" />
                </Form.Item>
              </Col>
            </Row>
            
            <Form.Item
              name="customerEmail"
              label="ÈõªÂ≠êÈÉµ‰ª∂"
              rules={[
                { required: true, message: 'Ë´ãËº∏ÂÖ•ÈõªÂ≠êÈÉµ‰ª∂' },
                { type: 'email', message: 'Ë´ãËº∏ÂÖ•Ê≠£Á¢∫ÁöÑÈÉµ‰ª∂Ê†ºÂºè' }
              ]}
            >
              <Input placeholder="Ë´ãËº∏ÂÖ•ÈõªÂ≠êÈÉµ‰ª∂" />
            </Form.Item>

            <Row gutter={16}>
              <Col span={8}>
                <Form.Item
                  name="city"
                  label="Á∏£Â∏Ç"
                  rules={[{ required: true, message: 'Ë´ãÈÅ∏ÊìáÁ∏£Â∏Ç' }]}
                >
                  <Select placeholder="Ë´ãÈÅ∏ÊìáÁ∏£Â∏Ç">
                    {cities.map(city => (
                      <Select.Option key={city} value={city}>{city}</Select.Option>
                    ))}
                  </Select>
                </Form.Item>
              </Col>
              <Col span={16}>
                <Form.Item
                  name="address"
                  label="Ë©≥Á¥∞Âú∞ÂùÄ"
                  rules={[{ required: true, message: 'Ë´ãËº∏ÂÖ•Ë©≥Á¥∞Âú∞ÂùÄ' }]}
                >
                  <Input prefix={<EnvironmentOutlined />} placeholder="Ë´ãËº∏ÂÖ•Ë©≥Á¥∞Âú∞ÂùÄ" />
                </Form.Item>
              </Col>
            </Row>

            <Form.Item name="notes" label="ÂÇôË®ª">
              <TextArea rows={3} placeholder="ÈÖçÈÄÅÂÇôË®ªÔºàÈÅ∏Â°´Ôºâ" />
            </Form.Item>
          </Form>
        );

      case 1:
        return (
          <Form form={form} layout="vertical">
            <Title level={4}>‰ªòÊ¨æÊñπÂºè</Title>
            <Form.Item
              name="paymentMethod"
              rules={[{ required: true, message: 'Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºè' }]}
            >
              <Radio.Group style={{ width: '100%' }}>
                <Space direction="vertical" style={{ width: '100%' }}>
                  {paymentMethods.map(method => (
                    <Radio key={method.value} value={method.value}>
                      <Card 
                        size="small" 
                        style={{ marginLeft: '24px', width: 'calc(100% - 24px)' }}
                        bodyStyle={{ padding: '12px 16px' }}
                      >
                        <Space>
                          <span style={{ fontSize: '20px' }}>{method.icon}</span>
                          <Text strong>{method.label}</Text>
                        </Space>
                        {method.description && (
                          <div style={{ marginTop: '8px', fontSize: '12px', color: '#666' }}>
                            {method.description}
                          </div>
                        )}
                        {method.settings && (
                          <div style={{ marginTop: '8px', fontSize: '12px', color: '#666' }}>
                            {method.settings.processingTime && (
                              <span>ËôïÁêÜÊôÇÈñì: {method.settings.processingTime}</span>
                            )}
                            {method.settings.extraFee && (
                              <span> ‚Ä¢ ÊâãÁ∫åË≤ª: NT$ {method.settings.extraFee}</span>
                            )}
                          </div>
                        )}
                      </Card>
                    </Radio>
                  ))}
                </Space>
              </Radio.Group>
            </Form.Item>
          </Form>
        );

      case 2:
        return (
          <div>
            <Title level={4}>Ë®ÇÂñÆÁ¢∫Ë™ç</Title>
            
            {/* ÂïÜÂìÅÊ∏ÖÂñÆ */}
            <Card title="Ë®ÇË≥ºÂïÜÂìÅ" style={{ marginBottom: '16px' }}>
              <List
                dataSource={cart}
                renderItem={(item) => (
                  <List.Item>
                    <List.Item.Meta
                      avatar={<div style={{ fontSize: '32px' }}>{item.image}</div>}
                      title={item.name}
                      description={`${item.farm} ‚Ä¢ ${item.location}`}
                    />
                    <div style={{ textAlign: 'right' }}>
                      <div>NT$ {item.price} √ó {item.quantity}</div>
                      <Text strong style={{ color: '#52c41a' }}>
                        NT$ {item.price * item.quantity}
                      </Text>
                    </div>
                  </List.Item>
                )}
              />
            </Card>

            {/* ÈÖçÈÄÅË≥áË®ä */}
            <Card title="ÈÖçÈÄÅË≥áË®ä" style={{ marginBottom: '16px' }}>
              <Row gutter={[16, 8]}>
                <Col span={6}><Text strong>Êî∂‰ª∂‰∫∫Ôºö</Text></Col>
                <Col span={18}><Text>{orderData.customerName}</Text></Col>
                <Col span={6}><Text strong>ËÅØÁµ°ÈõªË©±Ôºö</Text></Col>
                <Col span={18}><Text>{orderData.customerPhone}</Text></Col>
                <Col span={6}><Text strong>ÈõªÂ≠êÈÉµ‰ª∂Ôºö</Text></Col>
                <Col span={18}><Text>{orderData.customerEmail}</Text></Col>
                <Col span={6}><Text strong>ÈÖçÈÄÅÂú∞ÂùÄÔºö</Text></Col>
                <Col span={18}><Text>{orderData.city} {orderData.address}</Text></Col>
                {orderData.notes && (
                  <>
                    <Col span={6}><Text strong>ÂÇôË®ªÔºö</Text></Col>
                    <Col span={18}><Text>{orderData.notes}</Text></Col>
                  </>
                )}
              </Row>
            </Card>

            {/* ‰ªòÊ¨æË≥áË®ä */}
            <Card title="‰ªòÊ¨æË≥áË®ä" style={{ marginBottom: '16px' }}>
              <Text strong>
                ‰ªòÊ¨æÊñπÂºèÔºö{paymentMethods.find(m => m.value === orderData.paymentMethod)?.label}
              </Text>
            </Card>

            {/* ÂÑ™ÊÉ†Âà∏Ë≥áË®ä */}
            {appliedCoupon && (
              <Card title="ÂÑ™ÊÉ†Âà∏Ë≥áË®ä" style={{ marginBottom: '16px' }}>
                <Alert
                  message={
                    <Space>
                      <Tag 
                        icon={appliedCoupon.type === 'fixed' ? <GiftOutlined /> : <PercentageOutlined />}
                        color={appliedCoupon.type === 'fixed' ? 'blue' : 'orange'}
                      >
                        {appliedCoupon.code}
                      </Tag>
                      <Text strong>{appliedCoupon.name}</Text>
                    </Space>
                  }
                  description={
                    <div>
                      <div>{appliedCoupon.description}</div>
                      <div style={{ color: '#52c41a', fontWeight: 'bold', marginTop: '4px' }}>
                        ÊäòÊâ£ÈáëÈ°çÔºöNT$ {discountAmount}
                      </div>
                    </div>
                  }
                  type="success"
                  showIcon
                />
              </Card>
            )}
          </div>
        );

      default:
        return null;
    }
  };

  return (
    <div style={{ padding: '40px 0', width: '100%', minHeight: 'calc(100vh - 200px)' }}>
      <div style={{ maxWidth: '1000px', margin: '0 auto', padding: '0 24px' }}>
        <Title level={2} style={{ textAlign: 'center', marginBottom: '40px' }}>
          ÁµêÂ∏≥
        </Title>

        <Row gutter={24}>
          <Col xs={24} lg={16}>
            <Card>
              <Steps 
                current={currentStep} 
                style={{ marginBottom: '32px' }}
                items={[
                  {
                    title: 'ÈÖçÈÄÅË≥áË®ä',
                    icon: <EnvironmentOutlined />
                  },
                  {
                    title: '‰ªòÊ¨æÊñπÂºè',
                    icon: <CreditCardOutlined />
                  },
                  {
                    title: 'Ë®ÇÂñÆÁ¢∫Ë™ç',
                    icon: <CheckCircleOutlined />
                  }
                ]}
              />

              {renderStepContent()}

              <Divider />

              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <div>
                  {currentStep > 0 && (
                    <Button onClick={handlePrev}>
                      ‰∏ä‰∏ÄÊ≠•
                    </Button>
                  )}
                </div>
                <div>
                  <Button style={{ marginRight: '8px' }} onClick={() => onPageChange('cart')}>
                    ËøîÂõûË≥ºÁâ©Ëªä
                  </Button>
                  <Button 
                    type="primary" 
                    onClick={handleNext}
                    loading={loading}
                  >
                    {currentStep < 2 ? '‰∏ã‰∏ÄÊ≠•' : 'Êèê‰∫§Ë®ÇÂñÆ'}
                  </Button>
                </div>
              </div>
            </Card>
          </Col>

          <Col xs={24} lg={8}>
            <Card title="Ë®ÇÂñÆÊëòË¶Å" style={{ position: 'sticky', top: '24px' }}>
              <Space direction="vertical" size="middle" style={{ width: '100%' }}>
                <Row justify="space-between">
                  <Text>ÂïÜÂìÅÁ∏ΩË®à</Text>
                  <Text strong>NT$ {subtotal}</Text>
                </Row>
                <Row justify="space-between">
                  <Text>ÈÅãË≤ª</Text>
                  <Text strong>NT$ {shippingFee}</Text>
                </Row>
                {appliedCoupon && discountAmount > 0 && (
                  <Row justify="space-between">
                    <Text>ÂÑ™ÊÉ†ÊäòÊâ£</Text>
                    <Text strong style={{ color: '#52c41a' }}>-NT$ {discountAmount}</Text>
                  </Row>
                )}
                <Divider style={{ margin: '8px 0' }} />
                <Row justify="space-between">
                  <Title level={4}>Á∏ΩË®à</Title>
                  <Title level={4} style={{ color: '#52c41a' }}>
                    NT$ {totalAmount}
                  </Title>
                </Row>
                
                <div style={{ fontSize: '12px', color: '#666', textAlign: 'center' }}>
                  ÈªûÊìä„ÄåÊèê‰∫§Ë®ÇÂñÆ„ÄçÂç≥Ë°®Á§∫ÊÇ®ÂêåÊÑèÊàëÂÄëÁöÑÊúçÂãôÊ¢ùÊ¨æ
                </div>
              </Space>
            </Card>
          </Col>
        </Row>
      </div>
      
      {/* Ë®ÇÂñÆÊàêÂäü Modal */}
      <Modal
        title={
          <div style={{ textAlign: 'center' }}>
            <CheckCircleOutlined style={{ color: '#52c41a', fontSize: '48px', marginBottom: '16px' }} />
            <div>Ë®ÇÂñÆÊèê‰∫§ÊàêÂäüÔºÅ</div>
          </div>
        }
        open={orderSuccessModalVisible}
        onOk={() => {
          setOrderSuccessModalVisible(false);
          onOrderComplete?.();
          onPageChange('home');
        }}
        onCancel={() => {
          setOrderSuccessModalVisible(false);
          onOrderComplete?.();
          onPageChange('home');
        }}
        okText="ËøîÂõûÈ¶ñÈ†Å"
        cancelText="ÁπºÁ∫åË≥ºÁâ©"
        centered
        width={500}
      >
        {orderResult && (
          <div style={{ textAlign: 'center' }}>
            <p style={{ fontSize: '16px', marginBottom: '16px' }}>
              ÊÇ®ÁöÑË®ÇÂñÆÁ∑®ËôüÔºö<Text strong style={{ color: '#1890ff' }}>{orderResult.orderId}</Text>
            </p>
            <p style={{ marginBottom: '16px' }}>
              ÊàëÂÄëÂ∞áÁõ°Âø´ÁÇ∫ÊÇ®ËôïÁêÜË®ÇÂñÆÔºåÊÑüË¨ùÊÇ®ÁöÑË≥ºË≤∑ÔºÅ
            </p>
            {orderResult.emailSuccess ? (
              <p style={{ color: '#52c41a', marginBottom: '8px' }}>
                ‚úÖ Ë®ÇÂñÆÁ¢∫Ë™çÈÉµ‰ª∂Â∑≤ÁôºÈÄÅËá≥ÊÇ®ÁöÑ‰ø°ÁÆ±
              </p>
            ) : (
              <p style={{ color: '#faad14', marginBottom: '8px' }}>
                ‚ö†Ô∏è Ë®ÇÂñÆÂ∑≤Âª∫Á´ãÔºå‰ΩÜÈÉµ‰ª∂ÁôºÈÄÅÂèØËÉΩÊúâÂª∂ÈÅ≤
              </p>
            )}
            <div style={{ 
              background: '#f6ffed', 
              border: '1px solid #b7eb8f', 
              borderRadius: '6px', 
              padding: '12px', 
              marginTop: '16px',
              fontSize: '14px',
              color: '#389e0d'
            }}>
              üí° ÊÇ®ÂèØ‰ª•Èö®ÊôÇËÅØÁπ´ÊàëÂÄëÊü•Ë©¢Ë®ÇÂñÆÁãÄÊÖã
            </div>
          </div>
        )}
      </Modal>
    </div>
  );
};

export default CheckoutPage;